{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="/static/modern-styles.css">

<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <h1 class="dashboard-title">AutoProfit</h1>
    <p class="dashboard-subtitle">Discover profitable automotive opportunities with advanced market analysis</p>
  </div>

  <!-- Filters Container -->
  <div class="filters-container">
    <!-- Time-based Filters -->
    <div class="filter-card glass-card">
      <h3 class="filter-title">Time Period</h3>
      <div class="time-filters">
        <button class="time-toggle active" data-timeframe="24h" onclick="setTimeFilter(this)">24H</button>
        <button class="time-toggle" data-timeframe="3d" onclick="setTimeFilter(this)">3D</button>
        <button class="time-toggle" data-timeframe="7d" onclick="setTimeFilter(this)">7D</button>
        <button class="time-toggle" data-timeframe="30d" onclick="setTimeFilter(this)">30D</button>
        <button class="time-toggle" data-timeframe="" onclick="setTimeFilter(this)">All Time</button>
      </div>
    </div>

    <!-- Search and Brand Filters -->
    <div class="filter-card glass-card">
      <h3 class="filter-title">Search & Brand</h3>
      <div class="search-container">
        <div class="input-group">
          <label class="input-label">Search Vehicles</label>
          <input type="text" id="search-input" placeholder="BMW M3, Audi Q5..." class="glass-input">
        </div>
        <div class="input-group">
          <label class="input-label">Brand</label>
          <select id="make-filter" class="glass-select">
            <option value="">All Brands</option>
          </select>
        </div>
        <div class="action-buttons">
          <button onclick="applyFilters()" class="btn-primary">Apply</button>
          <button onclick="clearFilters()" class="btn-secondary">Clear</button>
        </div>
      </div>
    </div>

    <!-- Price Bracket Filter -->
    <div class="filter-card glass-card">
      <h3 class="filter-title">Price Brackets</h3>
      <div class="price-brackets">
        <button class="price-bracket active" data-min="" data-max="" onclick="setPriceBracket(this)">All Prices</button>
        <button class="price-bracket" data-min="0" data-max="15000" onclick="setPriceBracket(this)">Under $15K</button>
        <button class="price-bracket" data-min="15000" data-max="30000" onclick="setPriceBracket(this)">$15K - $30K</button>
        <button class="price-bracket" data-min="30000" data-max="50000" onclick="setPriceBracket(this)">$30K - $50K</button>
        <button class="price-bracket" data-min="50000" data-max="100000" onclick="setPriceBracket(this)">$50K - $100K</button>
        <button class="price-bracket" data-min="100000" data-max="" onclick="setPriceBracket(this)">$100K+</button>
      </div>
    </div>
  </div>

  <!-- Category Filters -->
  <div class="category-filters">
    <button class="category-btn active profitable" data-category="PROFITABLE" onclick="setCategoryFilter(this)">
      üí∞ Profitable Deals
    </button>
    <button class="category-btn maybe" data-category="MAYBE" onclick="setCategoryFilter(this)">
      ü§î Maybe Worth It
    </button>
    <button class="category-btn unknown" data-category="UNKNOWN" onclick="setCategoryFilter(this)">
      ‚ùì Unknown Potential
    </button>
  </div>

  <!-- Results -->
  <div id="results" hx-get="/listings?category=PROFITABLE&timeframe=24h" hx-trigger="load">
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <p>Loading profitable deals...</p>
    </div>
  </div>
</div>

<script>
// State management
let currentFilters = {
  category: 'PROFITABLE',
  timeframe: '24h',
  search: '',
  makeFilter: '',
  minPrice: '',
  maxPrice: ''
};

// Load makes when page loads
document.addEventListener('DOMContentLoaded', function() {
  loadMakes();
  
  // Add Enter key listener for search input
  document.getElementById('search-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      applyFilters();
    }
  });
});

// Load available makes for dropdown
async function loadMakes() {
  try {
    const response = await fetch('/api/makes');
    const data = await response.json();
    const makeSelect = document.getElementById('make-filter');
    
    // Clear existing options except first
    makeSelect.innerHTML = '<option value="">All Brands</option>';
    
    // Add makes
    data.makes.forEach(make => {
      const option = document.createElement('option');
      option.value = make;
      option.textContent = make;
      makeSelect.appendChild(option);
    });
  } catch (error) {
    console.error('Error loading makes:', error);
  }
}

// Time filter handler
function setTimeFilter(button) {
  // Remove active class from all time buttons
  document.querySelectorAll('.time-toggle').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Add active class to clicked button
  button.classList.add('active');
  
  // Update current filters
  currentFilters.timeframe = button.dataset.timeframe;
  
  // Apply filters immediately
  applyFilters();
}

// Category filter handler
function setCategoryFilter(button) {
  // Remove active class from all category buttons
  document.querySelectorAll('.category-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Add active class to clicked button
  button.classList.add('active');
  
  // Update current filters
  currentFilters.category = button.dataset.category;
  
  // Apply filters immediately
  applyFilters();
}

// Apply all filters
function applyFilters() {
  // Update current filters from form inputs
  currentFilters.search = document.getElementById('search-input').value;
  currentFilters.makeFilter = document.getElementById('make-filter').value;
  // Note: minPrice and maxPrice are set by setPriceBracket function
  
  // Build URL with all filters
  let url = `/listings?category=${currentFilters.category}`;
  
  if (currentFilters.timeframe) {
    url += `&timeframe=${currentFilters.timeframe}`;
  }
  
  if (currentFilters.search) {
    url += `&search=${encodeURIComponent(currentFilters.search)}`;
  }
  
  if (currentFilters.makeFilter) {
    url += `&make_filter=${encodeURIComponent(currentFilters.makeFilter)}`;
  }
  
  if (currentFilters.minPrice) {
    url += `&min_price=${currentFilters.minPrice}`;
  }
  
  if (currentFilters.maxPrice) {
    url += `&max_price=${currentFilters.maxPrice}`;
  }
  
  // Use HTMX to load filtered results
  htmx.ajax('GET', url, {target: '#results'});
}

// Price bracket handler
function setPriceBracket(button) {
  // Remove active class from all price bracket buttons
  document.querySelectorAll('.price-bracket').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Add active class to clicked button
  button.classList.add('active');
  
  // Update current filters
  currentFilters.minPrice = button.dataset.min || '';
  currentFilters.maxPrice = button.dataset.max || '';
  
  // Apply filters immediately
  applyFilters();
}

// Clear all filters
function clearFilters() {
  // Reset form inputs
  document.getElementById('search-input').value = '';
  document.getElementById('make-filter').value = '';
  
  // Reset price bracket to "All Prices"
  document.querySelectorAll('.price-bracket').forEach(btn => {
    btn.classList.remove('active');
  });
  document.querySelector('[data-min=""][data-max=""]').classList.add('active');
  
  // Reset time filter to 24h
  document.querySelectorAll('.time-toggle').forEach(btn => {
    btn.classList.remove('active');
  });
  document.querySelector('[data-timeframe="24h"]').classList.add('active');
  
  // Update current filters
  currentFilters.search = '';
  currentFilters.makeFilter = '';
  currentFilters.minPrice = '';
  currentFilters.maxPrice = '';
  currentFilters.timeframe = '24h';
  
  // Apply filters (will show just category and 24h)
  applyFilters();
}
</script>
{% endblock %}
