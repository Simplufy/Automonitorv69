{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="/static/modern-styles.css">

<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <h1 class="dashboard-title">AutoProfit</h1>
    <p class="dashboard-subtitle">Discover profitable automotive opportunities with advanced market analysis</p>
  </div>

  <!-- Filters Container -->
  <div class="filters-container">
    <!-- Time-based Filters -->
    <div class="filter-card glass-card">
      <h3 class="filter-title">Time Period</h3>
      <div class="time-filters">
        <button class="time-toggle active" data-timeframe="24h" onclick="setTimeFilter(this)">24H</button>
        <button class="time-toggle" data-timeframe="3d" onclick="setTimeFilter(this)">3D</button>
        <button class="time-toggle" data-timeframe="7d" onclick="setTimeFilter(this)">7D</button>
        <button class="time-toggle" data-timeframe="30d" onclick="setTimeFilter(this)">30D</button>
        <button class="time-toggle" data-timeframe="" onclick="setTimeFilter(this)">All Time</button>
      </div>
    </div>

    <!-- Search and Brand Filters -->
    <div class="filter-card glass-card">
      <h3 class="filter-title">Search & Brand</h3>
      <div class="search-container">
        <div class="input-group">
          <label class="input-label">Search Vehicles</label>
          <input type="text" id="search-input" placeholder="BMW M3, Audi Q5..." class="glass-input">
        </div>
        <div class="action-buttons">
          <button onclick="applyFilters()" class="btn-primary">Apply</button>
          <button onclick="clearFilters()" class="btn-secondary">Clear</button>
        </div>
      </div>
    </div>

    <!-- Price Bracket Filter -->
    <div class="filter-card glass-card">
      <h3 class="filter-title">Price Brackets</h3>
      <div class="price-brackets">
        <button class="price-bracket active" data-min="" data-max="" onclick="setPriceBracket(this)">All Prices</button>
        <button class="price-bracket" data-min="0" data-max="15000" onclick="setPriceBracket(this)">Under $15K</button>
        <button class="price-bracket" data-min="15000" data-max="30000" onclick="setPriceBracket(this)">$15K - $30K</button>
        <button class="price-bracket" data-min="30000" data-max="50000" onclick="setPriceBracket(this)">$30K - $50K</button>
        <button class="price-bracket" data-min="50000" data-max="100000" onclick="setPriceBracket(this)">$50K - $100K</button>
        <button class="price-bracket" data-min="100000" data-max="" onclick="setPriceBracket(this)">$100K+</button>
      </div>
    </div>
    
    <!-- Data Management -->
    <div class="filter-card glass-card">
      <h3 class="filter-title">Data Management</h3>
      <div class="refresh-section">
        <button id="refresh-data-btn" class="refresh-btn" onclick="refreshData()">
          <span id="refresh-text">üîÑ Refresh Data (24h)</span>
          <span id="refresh-spinner" class="spinner" style="display: none;">‚è≥ Processing...</span>
        </button>
        <div id="refresh-status" class="refresh-status"></div>
      </div>
    </div>
  </div>

  <!-- Category Filters -->
  <div class="category-filters">
    <button class="category-btn active profitable" data-category="PROFITABLE" onclick="setCategoryFilter(this)">
      üí∞ Profitable Deals
    </button>
    <button class="category-btn maybe" data-category="MAYBE" onclick="setCategoryFilter(this)">
      ü§î Maybe Worth It
    </button>
    <button class="category-btn unknown" data-category="UNKNOWN" onclick="setCategoryFilter(this)">
      ‚ùì Unknown Potential
    </button>
  </div>

  <!-- Results -->
  <div id="results" hx-get="/listings?category=PROFITABLE&timeframe=24h" hx-trigger="load" hx-indicator="#loading">
    <div class="loading-state" id="loading">
      <div class="loading-spinner"></div>
      <p>Loading profitable deals...</p>
    </div>
  </div>
  
  <!-- Debug Info (remove after fixing) -->
  <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; font-family: monospace; font-size: 12px;">
    <strong>Debug Info:</strong><br>
    ‚Ä¢ Database: 2,682 PROFITABLE matches available<br>
    ‚Ä¢ API Status: <span id="api-status">Testing...</span><br>
    ‚Ä¢ HTMX Status: <span id="htmx-status">Loading...</span><br>
    ‚Ä¢ Time: <span id="debug-time"></span>
  </div>
</div>

<script>
// State management
let currentFilters = {
  category: 'PROFITABLE',
  timeframe: '24h',
  search: '',
  minPrice: '',
  maxPrice: ''
};

// Add Enter key listener for search input when page loads
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('search-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      applyFilters();
    }
  });
  
  // Debug info update
  document.getElementById('debug-time').textContent = new Date().toLocaleString();
  
  // Test API connectivity
  fetch('/listings?category=PROFITABLE&timeframe=24h')
    .then(response => {
      document.getElementById('api-status').textContent = 'Connected ‚úÖ (' + response.status + ')';
      return response.text();
    })
    .then(data => {
      if (data.length > 100) {
        document.getElementById('api-status').textContent = 'Connected ‚úÖ (Data: ' + data.length + ' chars)';
      } else {
        document.getElementById('api-status').textContent = 'Connected ‚ö†Ô∏è (Low data: ' + data.length + ' chars)';
      }
    })
    .catch(error => {
      document.getElementById('api-status').textContent = 'Failed ‚ùå (' + error.message + ')';
    });
  
  // Check HTMX status
  if (typeof htmx !== 'undefined') {
    document.getElementById('htmx-status').textContent = 'Loaded ‚úÖ';
    
    // Add HTMX event listeners for debugging
    document.body.addEventListener('htmx:beforeRequest', function(e) {
      console.log('HTMX: Starting request to', e.detail.requestConfig.path);
      document.getElementById('htmx-status').textContent = 'Requesting... ‚è≥';
    });
    
    document.body.addEventListener('htmx:afterRequest', function(e) {
      console.log('HTMX: Request completed', e.detail.xhr.status);
      if (e.detail.xhr.status === 200) {
        document.getElementById('htmx-status').textContent = 'Success ‚úÖ (' + e.detail.xhr.responseText.length + ' chars)';
      } else {
        document.getElementById('htmx-status').textContent = 'Error ‚ùå (' + e.detail.xhr.status + ')';
      }
    });
    
    document.body.addEventListener('htmx:responseError', function(e) {
      console.log('HTMX: Response error', e.detail);
      document.getElementById('htmx-status').textContent = 'Response Error ‚ùå';
    });
  } else {
    document.getElementById('htmx-status').textContent = 'Missing ‚ùå';
  }
});


// Time filter handler
function setTimeFilter(button) {
  // Remove active class from all time buttons
  document.querySelectorAll('.time-toggle').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Add active class to clicked button
  button.classList.add('active');
  
  // Update current filters
  currentFilters.timeframe = button.dataset.timeframe;
  
  // Apply filters immediately
  applyFilters();
}

// Category filter handler
function setCategoryFilter(button) {
  // Remove active class from all category buttons
  document.querySelectorAll('.category-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Add active class to clicked button
  button.classList.add('active');
  
  // Update current filters
  currentFilters.category = button.dataset.category;
  
  // Apply filters immediately
  applyFilters();
}

// Apply all filters
function applyFilters() {
  // Update current filters from form inputs
  currentFilters.search = document.getElementById('search-input').value;
  // Note: minPrice and maxPrice are set by setPriceBracket function
  
  // Build URL with all filters
  let url = `/listings?category=${currentFilters.category}`;
  
  if (currentFilters.timeframe) {
    url += `&timeframe=${currentFilters.timeframe}`;
  }
  
  if (currentFilters.search) {
    url += `&search=${encodeURIComponent(currentFilters.search)}`;
  }
  
  
  if (currentFilters.minPrice) {
    url += `&min_price=${currentFilters.minPrice}`;
  }
  
  if (currentFilters.maxPrice) {
    url += `&max_price=${currentFilters.maxPrice}`;
  }
  
  // Use HTMX to load filtered results
  htmx.ajax('GET', url, {target: '#results'});
}

// Price bracket handler
function setPriceBracket(button) {
  // Remove active class from all price bracket buttons
  document.querySelectorAll('.price-bracket').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Add active class to clicked button
  button.classList.add('active');
  
  // Update current filters
  currentFilters.minPrice = button.dataset.min || '';
  currentFilters.maxPrice = button.dataset.max || '';
  
  // Apply filters immediately
  applyFilters();
}

// Clear all filters
function clearFilters() {
  // Reset form inputs
  document.getElementById('search-input').value = '';
  
  // Reset price bracket to "All Prices"
  document.querySelectorAll('.price-bracket').forEach(btn => {
    btn.classList.remove('active');
  });
  document.querySelector('[data-min=""][data-max=""]').classList.add('active');
  
  // Reset time filter to 24h
  document.querySelectorAll('.time-toggle').forEach(btn => {
    btn.classList.remove('active');
  });
  document.querySelector('[data-timeframe="24h"]').classList.add('active');
  
  // Update current filters
  currentFilters.search = '';
  currentFilters.minPrice = '';
  currentFilters.maxPrice = '';
  currentFilters.timeframe = '24h';
  
  // Apply filters (will show just category and 24h)
  applyFilters();
}

// Refresh data function
async function refreshData() {
  const btn = document.getElementById('refresh-data-btn');
  const text = document.getElementById('refresh-text');
  const spinner = document.getElementById('refresh-spinner');
  const status = document.getElementById('refresh-status');
  
  // Show loading state
  btn.disabled = true;
  text.style.display = 'none';
  spinner.style.display = 'inline';
  status.innerHTML = '<div class="status-loading">üîÑ Refreshing data...</div>';
  
  try {
    const response = await fetch('/api/refresh-data', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    const result = await response.json();
    
    if (result.ok) {
      status.innerHTML = `
        <div class="status-success">
          ‚úÖ ${result.message}<br>
          <small>Last updated: ${new Date().toLocaleTimeString()}</small>
        </div>
      `;
      
      // Automatically refresh the current view after 2 seconds
      setTimeout(() => {
        applyFilters();
      }, 2000);
    } else {
      status.innerHTML = `
        <div class="status-error">
          ‚ùå ${result.message}
        </div>
      `;
    }
  } catch (error) {
    status.innerHTML = `
      <div class="status-error">
        ‚ùå Error refreshing data: ${error.message}
      </div>
    `;
  } finally {
    // Reset button state
    btn.disabled = false;
    text.style.display = 'inline';
    spinner.style.display = 'none';
  }
}
</script>
{% endblock %}
