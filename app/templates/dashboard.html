{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="/static/modern-styles.css?v=20250919-fix">

<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <h1 class="dashboard-title">AutoProfit</h1>
    <p class="dashboard-subtitle">Discover profitable automotive opportunities with advanced market analysis</p>
    <div class="header-actions">
      <div class="header-nav">
        <a href="/" class="nav-btn glass-btn">ğŸ“Š Dashboard</a>
        <a href="/admin" class="nav-btn glass-btn">âš™ï¸ Admin</a>
        <button id="refresh-data-btn" class="refresh-btn glass-btn" onclick="refreshData()">
          <span id="refresh-text">ğŸ”„ Refresh Data (24h)</span>
          <span id="refresh-spinner" class="spinner" style="display: none;">â³ Processing...</span>
        </button>
      </div>
      <div id="refresh-status" class="refresh-status"></div>
    </div>
  </div>

  <!-- Filters Container -->
  <div class="filters-container">
    <!-- Time-based Filters -->
    <div class="filter-card glass-card">
      <h3 class="filter-title">Time Period</h3>
      <div class="time-filters">
        <button class="time-toggle" data-timeframe="24h" onclick="setTimeFilter(this)">24H</button>
        <button class="time-toggle" data-timeframe="3d" onclick="setTimeFilter(this)">3D</button>
        <button class="time-toggle active" data-timeframe="7d" onclick="setTimeFilter(this)">7D</button>
        <button class="time-toggle" data-timeframe="30d" onclick="setTimeFilter(this)">30D</button>
        <button class="time-toggle" data-timeframe="" onclick="setTimeFilter(this)">All Time</button>
      </div>
    </div>

    <!-- Search and Brand Filters -->
    <div class="filter-card glass-card">
      <h3 class="filter-title">Search & Brand</h3>
      <div class="search-container">
        <div class="input-group">
          <label class="input-label">Search Vehicles</label>
          <input type="text" id="search-input" placeholder="BMW M3, Audi Q5..." class="glass-input">
        </div>
        <div class="action-buttons">
          <button onclick="applyFilters()" class="btn-primary apply-btn">Apply</button>
        </div>
      </div>
    </div>

    <!-- Platform Filter -->
    <div class="filter-card glass-card">
      <h3 class="filter-title">Platforms</h3>
      <div class="platform-filters">
        <button class="platform-btn active" data-source="" onclick="setPlatformFilter(this)">All Platforms</button>
        <button class="platform-btn" data-source="facebook_marketplace" onclick="setPlatformFilter(this)">ğŸ“˜ Facebook</button>
        <button class="platform-btn" data-source="cars_com" onclick="setPlatformFilter(this)">ğŸš— Cars.com</button>
        <button class="platform-btn" data-source="autotrader" onclick="setPlatformFilter(this)">ğŸ AutoTrader</button>
      </div>
    </div>
  </div>

  <!-- Second Filter Row -->
  <div class="filters-container">
    <!-- Price Bracket Filter -->
    <div class="filter-card glass-card">
      <h3 class="filter-title">Price Brackets</h3>
      <div class="price-brackets">
        <button class="price-bracket active" data-min="" data-max="" onclick="setPriceBracket(this)">All Prices</button>
        <button class="price-bracket" data-min="0" data-max="15000" onclick="setPriceBracket(this)">Under $15K</button>
        <button class="price-bracket" data-min="15000" data-max="30000" onclick="setPriceBracket(this)">$15K - $30K</button>
        <button class="price-bracket" data-min="30000" data-max="50000" onclick="setPriceBracket(this)">$30K - $50K</button>
        <button class="price-bracket" data-min="50000" data-max="100000" onclick="setPriceBracket(this)">$50K - $100K</button>
        <button class="price-bracket" data-min="100000" data-max="" onclick="setPriceBracket(this)">$100K+</button>
      </div>
    </div>
  </div>

  <!-- Category Filters -->
  <div class="category-filters">
    <button class="category-btn active profitable" data-category="PROFITABLE" onclick="setCategoryFilter(this)">
      ğŸ’° Profitable Deals
    </button>
    <button class="category-btn maybe" data-category="MAYBE" onclick="setCategoryFilter(this)">
      ğŸ¤” Maybe Worth It
    </button>
    <button class="category-btn unknown" data-category="UNKNOWN" onclick="setCategoryFilter(this)">
      â“ Unknown Potential
    </button>
  </div>

  <!-- Results -->
  <div id="results" hx-get="/listings?category=PROFITABLE&timeframe=7d" hx-trigger="load">
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <p>Loading profitable deals...</p>
    </div>
  </div>
</div>

<script>
// State management
let currentFilters = {
  category: 'PROFITABLE',
  timeframe: '7d',
  search: '',
  minPrice: '',
  maxPrice: '',
  source: ''
};

// Add Enter key listener for search input when page loads
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('search-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      applyFilters();
    }
  });
});


// Time filter handler
function setTimeFilter(button) {
  // Remove active class from all time buttons
  document.querySelectorAll('.time-toggle').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Add active class to clicked button
  button.classList.add('active');
  
  // Update current filters
  currentFilters.timeframe = button.dataset.timeframe;
  
  // Apply filters immediately
  applyFilters();
}

// Category filter handler
function setCategoryFilter(button) {
  // Remove active class from all category buttons
  document.querySelectorAll('.category-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Add active class to clicked button
  button.classList.add('active');
  
  // Update current filters
  currentFilters.category = button.dataset.category;
  
  // Apply filters immediately
  applyFilters();
}

// Apply all filters
function applyFilters() {
  // Update current filters from form inputs
  currentFilters.search = document.getElementById('search-input').value;
  // Note: minPrice and maxPrice are set by setPriceBracket function
  
  // Build URL with all filters
  let url = `/listings?category=${currentFilters.category}`;
  
  if (currentFilters.timeframe) {
    url += `&timeframe=${currentFilters.timeframe}`;
  }
  
  if (currentFilters.search) {
    url += `&search=${encodeURIComponent(currentFilters.search)}`;
  }
  
  
  if (currentFilters.minPrice) {
    url += `&min_price=${currentFilters.minPrice}`;
  }
  
  if (currentFilters.maxPrice) {
    url += `&max_price=${currentFilters.maxPrice}`;
  }
  
  if (currentFilters.source) {
    url += `&source=${currentFilters.source}`;
  }
  
  // Use HTMX to load filtered results
  htmx.ajax('GET', url, {target: '#results'});
}

// Platform filter handler
function setPlatformFilter(button) {
  // Remove active class from all platform buttons
  document.querySelectorAll('.platform-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Add active class to clicked button
  button.classList.add('active');
  
  // Update current filters
  currentFilters.source = button.dataset.source;
  
  // Apply filters immediately
  applyFilters();
}

// Price bracket handler
function setPriceBracket(button) {
  // Remove active class from all price bracket buttons
  document.querySelectorAll('.price-bracket').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Add active class to clicked button
  button.classList.add('active');
  
  // Update current filters
  currentFilters.minPrice = button.dataset.min || '';
  currentFilters.maxPrice = button.dataset.max || '';
  
  // Apply filters immediately
  applyFilters();
}

// Clear all filters
function clearFilters() {
  // Reset form inputs
  document.getElementById('search-input').value = '';
  
  // Reset price bracket to "All Prices"
  document.querySelectorAll('.price-bracket').forEach(btn => {
    btn.classList.remove('active');
  });
  document.querySelector('[data-min=""][data-max=""]').classList.add('active');
  
  // Reset platform filter to "All Platforms"
  document.querySelectorAll('.platform-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  document.querySelector('[data-source=""]').classList.add('active');
  
  // Reset time filter to 24h
  document.querySelectorAll('.time-toggle').forEach(btn => {
    btn.classList.remove('active');
  });
  document.querySelector('[data-timeframe="24h"]').classList.add('active');
  
  // Update current filters
  currentFilters.search = '';
  currentFilters.minPrice = '';
  currentFilters.maxPrice = '';
  currentFilters.source = '';
  currentFilters.timeframe = '24h';
  
  // Apply filters (will show just category and 24h)
  applyFilters();
}

// Refresh data function
async function refreshData() {
  const btn = document.getElementById('refresh-data-btn');
  const text = document.getElementById('refresh-text');
  const spinner = document.getElementById('refresh-spinner');
  const status = document.getElementById('refresh-status');
  
  // Show loading state
  btn.disabled = true;
  text.style.display = 'none';
  spinner.style.display = 'inline';
  status.innerHTML = '<div class="status-loading">ğŸ”„ Refreshing data...</div>';
  
  try {
    const response = await fetch('/api/refresh-data', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    const result = await response.json();
    
    if (result.ok) {
      status.innerHTML = `
        <div class="status-success">
          âœ… ${result.message}<br>
          <small>Last updated: ${new Date().toLocaleTimeString()}</small>
        </div>
      `;
      
      // Automatically refresh the current view after 2 seconds
      setTimeout(() => {
        applyFilters();
      }, 2000);
    } else {
      status.innerHTML = `
        <div class="status-error">
          âŒ ${result.message}
        </div>
      `;
    }
  } catch (error) {
    status.innerHTML = `
      <div class="status-error">
        âŒ Error refreshing data: ${error.message}
      </div>
    `;
  } finally {
    // Reset button state
    btn.disabled = false;
    text.style.display = 'inline';
    spinner.style.display = 'none';
  }
}
</script>
{% endblock %}
